<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Career Intelligence Pipeline - Admin Dashboard</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            color: #333;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        
        .header {
            background: white;
            border-radius: 12px;
            padding: 30px;
            margin-bottom: 20px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.1);
        }
        
        h1 {
            font-size: 32px;
            margin-bottom: 10px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        .subtitle {
            color: #666;
            font-size: 14px;
        }
        
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .stat-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
        }
        
        .stat-label {
            font-size: 12px;
            text-transform: uppercase;
            color: #999;
            letter-spacing: 1px;
            margin-bottom: 8px;
        }
        
        .stat-value {
            font-size: 32px;
            font-weight: 700;
            color: #667eea;
        }
        
        .actions {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .action-card {
            background: white;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
        }
        
        .action-card h3 {
            font-size: 18px;
            margin-bottom: 10px;
            color: #333;
        }
        
        .action-card p {
            font-size: 14px;
            color: #666;
            margin-bottom: 20px;
            line-height: 1.6;
        }
        
        .btn {
            display: inline-block;
            padding: 12px 24px;
            border-radius: 8px;
            border: none;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(102, 126, 234, 0.4);
        }
        
        .btn-secondary {
            background: #f0f0f0;
            color: #333;
        }
        
        .btn-secondary:hover {
            background: #e0e0e0;
        }
        
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .progress-container {
            background: white;
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            display: none;
        }
        
        .progress-container.active {
            display: block;
        }
        
        .progress-bar {
            width: 100%;
            height: 8px;
            background: #f0f0f0;
            border-radius: 4px;
            overflow: hidden;
            margin: 15px 0;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            transition: width 0.3s ease;
            width: 0%;
        }
        
        .progress-text {
            font-size: 14px;
            color: #666;
            margin-top: 10px;
        }
        
        .logs {
            background: white;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
        }
        
        .logs h3 {
            margin-bottom: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .log-container {
            background: #1e1e1e;
            border-radius: 8px;
            padding: 20px;
            max-height: 500px;
            overflow-y: auto;
            font-family: 'Monaco', 'Menlo', 'Consolas', monospace;
            font-size: 13px;
            line-height: 1.6;
        }
        
        .log-entry {
            margin-bottom: 8px;
            color: #d4d4d4;
        }
        
        .log-entry.info { color: #4fc3f7; }
        .log-entry.success { color: #81c784; }
        .log-entry.error { color: #e57373; }
        .log-entry.warning { color: #ffb74d; }
        
        .log-timestamp {
            color: #888;
            margin-right: 10px;
        }
        
        .spinner {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid rgba(102, 126, 234, 0.3);
            border-top-color: #667eea;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            margin-left: 10px;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .btn-copy {
            padding: 8px 16px;
            font-size: 12px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .btn-copy:hover {
            background: #5568d3;
        }
        
        .status-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .status-badge.ready { background: #e8f5e9; color: #2e7d32; }
        .status-badge.running { background: #fff3e0; color: #f57c00; }
        .status-badge.complete { background: #e3f2fd; color: #1976d2; }
        .status-badge.error { background: #ffebee; color: #c62828; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üöÄ Career Intelligence Pipeline</h1>
            <p class="subtitle">Admin Dashboard - Real-time monitoring and control</p>
        </div>
        
        <div class="stats" id="stats">
            <div class="stat-card">
                <div class="stat-label">Total Jobs</div>
                <div class="stat-value" id="stat-jobs">--</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Queue Pending</div>
                <div class="stat-value" id="stat-pending">--</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Completed</div>
                <div class="stat-value" id="stat-completed">--</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Errors</div>
                <div class="stat-value" id="stat-errors">--</div>
            </div>
        </div>
        
        <div class="actions">
            <div class="action-card">
                <h3>1Ô∏è‚É£ Initialize Database</h3>
                <p>Create all 38 tables and schema. Run this first.</p>
                <button class="btn btn-primary" onclick="runSetup('database')">
                    Setup Database
                </button>
            </div>
            
            <div class="action-card">
                <h3>2Ô∏è‚É£ Install AI Prompts</h3>
                <p>Load 38 AI query templates into the database.</p>
                <button class="btn btn-primary" onclick="runSetup('prompts')">
                    Install Prompts
                </button>
            </div>
            
            <div class="action-card">
                <h3>3Ô∏è‚É£ Import O*NET Jobs</h3>
                <p>Import 1,016 occupations and create queue (38,608 items).</p>
                <button class="btn btn-primary" onclick="runImport()">
                    Import Jobs
                </button>
            </div>
            
            <div class="action-card">
                <h3>4Ô∏è‚É£ Run AI Worker</h3>
                <p>Process queue items with OpenAI API calls.</p>
                <button class="btn btn-primary" onclick="runWorker()">
                    Start AI Worker
                </button>
                <button class="btn btn-secondary" onclick="stopWorker()" style="margin-left: 10px;">
                    Stop
                </button>
            </div>
        </div>
        
        <div class="progress-container" id="progress-container">
            <h3>
                <span id="progress-title">Processing...</span>
                <span class="status-badge running" id="progress-status">Running</span>
            </h3>
            <div class="progress-bar">
                <div class="progress-fill" id="progress-fill"></div>
            </div>
            <div class="progress-text" id="progress-text">Initializing...</div>
        </div>
        
        <div class="logs">
            <h3>
                <span>üìã System Logs</span>
                <button class="btn-copy" onclick="copyLogs()">Copy All Logs</button>
            </h3>
            <div class="log-container" id="log-container">
                <div class="log-entry info">
                    <span class="log-timestamp">[System]</span>
                    Admin dashboard initialized. Ready to start operations.
                </div>
            </div>
        </div>
    </div>
    
    <script>
        const API_BASE = window.location.origin;
        const ADMIN_TOKEN = 'secure-random-token-2025';
        let workerInterval = null;
        
        function getTimestamp() {
            return new Date().toLocaleTimeString();
        }
        
        function addLog(message, type = 'info') {
            const container = document.getElementById('log-container');
            const entry = document.createElement('div');
            entry.className = `log-entry ${type}`;
            entry.innerHTML = `<span class="log-timestamp">[${getTimestamp()}]</span>${message}`;
            container.appendChild(entry);
            container.scrollTop = container.scrollHeight;
        }
        
        function copyLogs() {
            const container = document.getElementById('log-container');
            const text = Array.from(container.children)
                .map(el => el.textContent)
                .join('\n');
            navigator.clipboard.writeText(text);
            addLog('‚úì Logs copied to clipboard', 'success');
        }
        
        function showProgress(title) {
            const container = document.getElementById('progress-container');
            const titleEl = document.getElementById('progress-title');
            const statusEl = document.getElementById('progress-status');
            
            titleEl.textContent = title;
            statusEl.textContent = 'Running';
            statusEl.className = 'status-badge running';
            container.classList.add('active');
        }
        
        function hideProgress() {
            const container = document.getElementById('progress-container');
            container.classList.remove('active');
        }
        
        function updateProgress(percent, text) {
            document.getElementById('progress-fill').style.width = percent + '%';
            document.getElementById('progress-text').textContent = text;
        }
        
        async function fetchWithAuth(url, options = {}) {
            try {
                console.log('Fetching:', url, options.method || 'GET');
                const headers = {
                    'Authorization': `Bearer ${ADMIN_TOKEN}`,
                    'Content-Type': 'application/json',
                    ...options.headers
                };
                
                const response = await fetch(url, { ...options, headers });
                console.log('Response status:', response.status);
                
                if (!response.ok) {
                    const error = await response.json().catch(() => ({ message: response.statusText }));
                    console.error('API Error:', error);
                    throw new Error(error.message || error.error || 'Request failed');
                }
                const data = await response.json();
                console.log('Response data:', data);
                return data;
            } catch (error) {
                console.error('Fetch error:', error);
                addLog(`Network error: ${error.message}`, 'error');
                throw error;
            }
        }
        
        async function loadStats() {
            try {
                console.log('Loading stats...');
                const data = await fetchWithAuth(`${API_BASE}/api/admin/status`);
                document.getElementById('stat-jobs').textContent = data.jobs.total.toLocaleString();
                document.getElementById('stat-pending').textContent = (data.progress.pending || 0).toLocaleString();
                document.getElementById('stat-completed').textContent = (data.progress.completed || 0).toLocaleString();
                document.getElementById('stat-errors').textContent = (data.progress.errors || 0).toLocaleString();
                console.log('Stats loaded successfully');
            } catch (error) {
                console.error('loadStats error:', error);
                addLog(`Error loading stats: ${error.message}`, 'error');
            }
        }
        
        async function runSetup(type) {
            const titles = {
                database: 'Setting up database schema...',
                prompts: 'Installing AI prompt templates...'
            };
            
            try {
                addLog(`Starting ${type} setup...`, 'info');
                showProgress(titles[type]);
                updateProgress(0, 'Initializing...');
                
                const data = await fetchWithAuth(`${API_BASE}/api/admin/setup/${type}`, {
                    method: 'POST'
                });
                
                updateProgress(100, 'Complete!');
                addLog(`‚úì ${data.message}`, 'success');
                
                setTimeout(() => {
                    hideProgress();
                    loadStats();
                }, 1500);
            } catch (error) {
                addLog(`‚úó Setup failed: ${error.message}`, 'error');
                hideProgress();
            }
        }
        
        async function runImport() {
            try {
                addLog('Starting O*NET job import (1,016 occupations)...', 'info');
                showProgress('Importing O*NET Jobs');
                updateProgress(0, 'Reading embedded data...');
                
                const startTime = Date.now();
                let progress = 0;
                
                // Simulate progress while import runs
                const progressInterval = setInterval(() => {
                    progress = Math.min(progress + 2, 90);
                    updateProgress(progress, `Importing jobs and creating queue items... ${progress}%`);
                }, 500);
                
                const data = await fetchWithAuth(`${API_BASE}/api/admin/setup/import`, {
                    method: 'POST'
                });
                
                clearInterval(progressInterval);
                
                const elapsed = ((Date.now() - startTime) / 1000).toFixed(1);
                updateProgress(100, `Complete in ${elapsed}s!`);
                addLog(`‚úì ${data.message} (${elapsed}s)`, 'success');
                
                setTimeout(() => {
                    hideProgress();
                    loadStats();
                }, 2000);
            } catch (error) {
                addLog(`‚úó Import failed: ${error.message}`, 'error');
                hideProgress();
            }
        }
        
        async function runWorker() {
            try {
                addLog('Starting AI worker...', 'info');
                addLog('Processing queue with OpenAI API...', 'info');
                showProgress('AI Worker Running');
                
                // Start worker monitoring
                workerInterval = setInterval(async () => {
                    await loadStats();
                    const stats = await fetchWithAuth(`${API_BASE}/api/admin/status`);
                    const total = stats.progress.total || 1;
                    const completed = stats.progress.completed || 0;
                    const percent = Math.round((completed / total) * 100);
                    
                    updateProgress(percent, `${completed.toLocaleString()} / ${total.toLocaleString()} items processed`);
                    
                    if (completed >= total && total > 0) {
                        stopWorker();
                        addLog('‚úì AI worker completed all items!', 'success');
                    }
                }, 5000);
                
                // Call worker endpoint
                const response = await fetchWithAuth(`${API_BASE}/api/admin/worker/start`, {
                    method: 'POST',
                    body: JSON.stringify({ maxItems: 100 })
                });
                
                addLog(`Worker started: ${response.message}`, 'success');
                
            } catch (error) {
                addLog(`‚úó Worker error: ${error.message}`, 'error');
                stopWorker();
            }
        }
        
        function stopWorker() {
            if (workerInterval) {
                clearInterval(workerInterval);
                workerInterval = null;
                hideProgress();
                addLog('Worker monitoring stopped', 'info');
            }
        }
        
        // Auto-refresh stats every 10 seconds
        setInterval(loadStats, 10000);
        
        // Initial load
        loadStats();
    </script>
</body>
</html>

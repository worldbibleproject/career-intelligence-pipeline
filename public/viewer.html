<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Career Intelligence Data Viewer</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            background: white;
            border-radius: 16px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.1);
        }

        .header h1 {
            font-size: 32px;
            color: #667eea;
            margin-bottom: 10px;
        }

        .header p {
            color: #666;
            font-size: 16px;
        }

        .job-selector {
            background: white;
            border-radius: 16px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.1);
        }

        .job-selector h2 {
            font-size: 24px;
            color: #333;
            margin-bottom: 20px;
        }

        .search-box {
            width: 100%;
            padding: 15px 20px;
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            font-size: 16px;
            margin-bottom: 20px;
            transition: all 0.3s ease;
        }

        .search-box:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .job-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 15px;
            max-height: 400px;
            overflow-y: auto;
            padding: 10px;
        }

        .job-card {
            background: #f8f9fa;
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            padding: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .job-card:hover {
            border-color: #667eea;
            background: #f0f3ff;
            transform: translateY(-2px);
        }

        .job-card.selected {
            border-color: #667eea;
            background: #667eea;
            color: white;
        }

        .job-card h3 {
            font-size: 18px;
            margin-bottom: 8px;
        }

        .job-card .soc {
            font-size: 14px;
            opacity: 0.7;
            margin-bottom: 8px;
        }

        .job-card .stats {
            font-size: 13px;
            opacity: 0.8;
        }

        .data-container {
            background: white;
            border-radius: 16px;
            padding: 30px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.1);
            display: none;
        }

        .data-container.active {
            display: block;
        }

        .job-header {
            border-bottom: 3px solid #667eea;
            padding-bottom: 20px;
            margin-bottom: 30px;
        }

        .job-title {
            font-size: 32px;
            color: #333;
            margin-bottom: 10px;
        }

        .job-meta {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
            margin-top: 15px;
        }

        .job-meta .badge {
            background: #667eea;
            color: white;
            padding: 8px 16px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
        }

        .query-sections {
            display: grid;
            gap: 20px;
        }

        .query-card {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 25px;
            border-left: 4px solid #667eea;
            transition: all 0.3s ease;
        }

        .query-card:hover {
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
        }

        .query-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            cursor: pointer;
        }

        .query-title {
            font-size: 20px;
            color: #333;
            font-weight: 600;
        }

        .query-status {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 14px;
        }

        .status-badge {
            padding: 6px 12px;
            border-radius: 6px;
            font-weight: 500;
        }

        .status-success {
            background: #d4edda;
            color: #155724;
        }

        .status-missing {
            background: #f8d7da;
            color: #721c24;
        }

        .query-content {
            display: none;
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #ddd;
        }

        .query-content.expanded {
            display: block;
        }

        .data-preview {
            background: white;
            border-radius: 8px;
            padding: 20px;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            max-height: 600px;
            overflow: auto;
            white-space: pre-wrap;
            word-wrap: break-word;
        }

        .expand-icon {
            transition: transform 0.3s ease;
        }

        .expand-icon.expanded {
            transform: rotate(180deg);
        }

        .loading {
            text-align: center;
            padding: 40px;
            font-size: 18px;
            color: #666;
        }

        .error {
            background: #f8d7da;
            color: #721c24;
            padding: 20px;
            border-radius: 12px;
            margin: 20px 0;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #666;
        }

        .empty-state h3 {
            font-size: 24px;
            margin-bottom: 10px;
        }

        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .summary-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
        }

        .summary-card h3 {
            font-size: 16px;
            opacity: 0.9;
            margin-bottom: 10px;
        }

        .summary-card .value {
            font-size: 32px;
            font-weight: bold;
        }

        /* Special formatting for AI Trajectory */
        .ai-trajectory-section {
            border-left-color: #ff6b6b;
        }

        .ai-trajectory-timeline {
            display: grid;
            gap: 15px;
            margin-top: 20px;
        }

        .timeline-item {
            background: white;
            padding: 15px;
            border-radius: 8px;
            display: grid;
            grid-template-columns: 80px 1fr;
            gap: 15px;
            align-items: center;
        }

        .timeline-year {
            font-size: 20px;
            font-weight: bold;
            color: #667eea;
            text-align: center;
        }

        .timeline-data {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .takeover-pct {
            font-size: 24px;
            font-weight: bold;
            color: #ff6b6b;
        }

        .confidence {
            padding: 4px 12px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 500;
            text-transform: uppercase;
        }

        .confidence-high {
            background: #d4edda;
            color: #155724;
        }

        .confidence-medium {
            background: #fff3cd;
            color: #856404;
        }

        .confidence-low {
            background: #f8d7da;
            color: #721c24;
        }

        .key-factors {
            margin-top: 10px;
            padding-left: 20px;
        }

        .key-factors li {
            margin: 5px 0;
            color: #555;
        }

        .ai-analysis-text {
            background: white;
            padding: 20px;
            border-radius: 8px;
            line-height: 1.8;
            color: #333;
            margin-top: 15px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üéØ Career Intelligence Data Viewer</h1>
            <p>Browse and explore comprehensive AI-generated career analysis data for all occupations</p>
        </div>

        <div class="job-selector">
            <h2>üìã Select an Occupation</h2>
            <input 
                type="text" 
                class="search-box" 
                id="searchBox" 
                placeholder="üîç Search by job title or SOC code..."
            >
            <div class="job-grid" id="jobGrid">
                <div class="loading">Loading occupations...</div>
            </div>
        </div>

        <div class="data-container" id="dataContainer">
            <div class="loading">Loading data...</div>
        </div>
    </div>

    <script>
        let allJobs = [];
        let selectedJobId = null;
        let jobResults = {};

        // Load all jobs with results
        async function loadJobs() {
            try {
                const response = await fetch('/api/jobs?limit=100');
                const data = await response.json();
                const jobs = data.jobs || [];
                
                // Get result counts for each job
                const jobsWithCounts = await Promise.all(
                    jobs.map(async (job) => {
                        try {
                            const countRes = await fetch(`/api/jobs/${job.id}/data`);
                            const data = await countRes.json();
                            return {
                                ...job,
                                resultCount: data.count || 0
                            };
                        } catch {
                            return {
                                ...job,
                                resultCount: 0
                            };
                        }
                    })
                );

                // Filter to only jobs with results
                allJobs = jobsWithCounts.filter(job => job.resultCount > 0);
                displayJobs(allJobs);
            } catch (error) {
                document.getElementById('jobGrid').innerHTML = `
                    <div class="error">Failed to load jobs: ${error.message}</div>
                `;
            }
        }

        function displayJobs(jobs) {
            const grid = document.getElementById('jobGrid');
            
            if (jobs.length === 0) {
                grid.innerHTML = `
                    <div class="empty-state">
                        <h3>No jobs with results found</h3>
                        <p>Run the AI worker to generate data first.</p>
                    </div>
                `;
                return;
            }

            grid.innerHTML = jobs.map(job => `
                <div class="job-card ${selectedJobId === job.id ? 'selected' : ''}" 
                     onclick="selectJob(${job.id})">
                    <h3>${job.canonicaltitle || job.canonicalTitle}</h3>
                    <div class="soc">SOC: ${job.soccode || job.socCode || 'N/A'}</div>
                    <div class="stats">‚úÖ ${job.resultCount}/39 queries complete</div>
                </div>
            `).join('');
        }

        async function selectJob(jobId) {
            selectedJobId = jobId;
            
            // Update selected state in grid
            document.querySelectorAll('.job-card').forEach(card => {
                card.classList.remove('selected');
            });
            event.target.closest('.job-card').classList.add('selected');

            // Load job data
            await loadJobData(jobId);
        }

        async function loadJobData(jobId) {
            const container = document.getElementById('dataContainer');
            container.classList.add('active');
            container.innerHTML = '<div class="loading">Loading job data...</div>';

            try {
                // Get job details
                const jobRes = await fetch(`/api/jobs/${jobId}`);
                const jobData = await jobRes.json();
                const job = jobData.job || jobData;

                // Get all query results
                const dataRes = await fetch(`/api/jobs/${jobId}/data`);
                const dataResponse = await dataRes.json();
                const results = dataResponse.data || [];

                // Build results map
                jobResults = {};
                results.forEach(r => {
                    jobResults[r.query_id] = r.response_data;
                });

                displayJobData(job, results);
            } catch (error) {
                container.innerHTML = `<div class="error">Failed to load job data: ${error.message}</div>`;
            }
        }

        function displayJobData(job, results) {
            const container = document.getElementById('dataContainer');
            
            const allQueries = [
                { id: 'job-taxonomy', name: 'Job Taxonomy', icon: 'üìä' },
                { id: 'job-keywords', name: 'Keywords', icon: 'üîë' },
                { id: 'task-analysis', name: 'Task Analysis', icon: 'üìã' },
                { id: 'ai-resistance', name: 'AI Resistance', icon: 'ü§ñ' },
                { id: 'growth-projection', name: 'Growth Projection', icon: 'üìà' },
                { id: 'economics-analysis', name: 'Economics Analysis', icon: 'üí∞' },
                { id: 'roi-modeling', name: 'ROI Modeling', icon: 'üìä' },
                { id: 'family-economics', name: 'Family Economics', icon: 'üë®‚Äçüë©‚Äçüëß‚Äçüë¶' },
                { id: 'training-paths', name: 'Training Paths', icon: 'üéì' },
                { id: 'licensure-requirements', name: 'Licensure Requirements', icon: 'üìú' },
                { id: 'compliance-flags', name: 'Compliance Flags', icon: '‚ö†Ô∏è' },
                { id: 'start-now', name: 'Start Now Steps', icon: 'üöÄ' },
                { id: 'tools-equipment', name: 'Tools & Equipment', icon: 'üîß' },
                { id: 'suitability', name: 'Suitability', icon: '‚úÖ' },
                { id: 'faith-alignment', name: 'Faith Alignment', icon: 'üôè' },
                { id: 'risks', name: 'Risks', icon: '‚ö†Ô∏è' },
                { id: 'geographic-variations', name: 'Geographic Variations', icon: 'üó∫Ô∏è' },
                { id: 'industry-context', name: 'Industry Context', icon: 'üè≠' },
                { id: 'provenance', name: 'Provenance', icon: 'üìö' },
                { id: 'safety-analysis', name: 'Safety Analysis', icon: 'ü¶∫' },
                { id: 'regional-licensing', name: 'Regional Licensing', icon: 'üìç' },
                { id: 'enhanced-economics', name: 'Enhanced Economics', icon: 'üíµ' },
                { id: 'advanced-family-planning', name: 'Advanced Family Planning', icon: 'üë™' },
                { id: 'college-alternatives', name: 'College Alternatives', icon: 'üéØ' },
                { id: 'portfolio-planning', name: 'Portfolio Planning', icon: 'üíº' },
                { id: 'daily-life', name: 'Daily Life', icon: 'üåÖ' },
                { id: 'lesson-plans', name: 'Lesson Plans', icon: 'üìù' },
                { id: 'market-saturation', name: 'Market Saturation', icon: 'üìä' },
                { id: 'accessibility', name: 'Accessibility', icon: '‚ôø' },
                { id: 'unionization', name: 'Unionization', icon: 'ü§ù' },
                { id: 'career-ladders', name: 'Career Ladders', icon: 'ü™ú' },
                { id: 'remote-work', name: 'Remote Work', icon: 'üè†' },
                { id: 'time-flexibility', name: 'Time Flexibility', icon: '‚è∞' },
                { id: 'entrepreneurship', name: 'Entrepreneurship', icon: 'üí°' },
                { id: 'side-hustle', name: 'Side Hustle', icon: 'üí∏' },
                { id: 'retirement-planning', name: 'Retirement Planning', icon: 'üèñÔ∏è' },
                { id: 'income-stability', name: 'Income Stability', icon: 'üìâ' },
                { id: 'job-satisfaction', name: 'Job Satisfaction', icon: 'üòä' },
                { id: 'ai-trajectory-analysis', name: 'AI Trajectory Analysis', icon: 'üöÄü§ñ' }
            ];

            const completedCount = results.length;
            const totalCount = allQueries.length;
            const completionPct = Math.round((completedCount / totalCount) * 100);

            const jobTitle = job.canonicaltitle || job.canonicalTitle || job.title || 'Unknown';
            const socCode = job.soccode || job.socCode || job.soc_code || 'N/A';
            const jobZone = job.jobzone || job.jobZone || job.job_zone || 'N/A';

            container.innerHTML = `
                <div class="job-header">
                    <h2 class="job-title">${jobTitle}</h2>
                    <div class="job-meta">
                        <span class="badge">SOC: ${socCode}</span>
                        <span class="badge">Job Zone: ${jobZone}</span>
                    </div>
                </div>

                <div class="summary-grid">
                    <div class="summary-card">
                        <h3>Queries Complete</h3>
                        <div class="value">${completedCount}/${totalCount}</div>
                    </div>
                    <div class="summary-card">
                        <h3>Completion</h3>
                        <div class="value">${completionPct}%</div>
                    </div>
                    <div class="summary-card">
                        <h3>Data Size</h3>
                        <div class="value">${formatDataSize(results)}</div>
                    </div>
                </div>

                <div class="query-sections">
                    ${allQueries.map(query => generateQueryCard(query, jobResults[query.id])).join('')}
                </div>
            `;
        }

        function formatDataSize(results) {
            const totalBytes = JSON.stringify(results).length;
            if (totalBytes < 1024) return totalBytes + ' B';
            if (totalBytes < 1024 * 1024) return (totalBytes / 1024).toFixed(1) + ' KB';
            return (totalBytes / (1024 * 1024)).toFixed(1) + ' MB';
        }

        function generateQueryCard(query, data) {
            const hasData = !!data;
            const isAITrajectory = query.id === 'ai-trajectory-analysis';

            return `
                <div class="query-card ${isAITrajectory ? 'ai-trajectory-section' : ''}">
                    <div class="query-header" onclick="toggleQuery('${query.id}')">
                        <div class="query-title">${query.icon} ${query.name}</div>
                        <div class="query-status">
                            <span class="status-badge ${hasData ? 'status-success' : 'status-missing'}">
                                ${hasData ? '‚úì Complete' : '‚úó Missing'}
                            </span>
                            ${hasData ? '<span class="expand-icon" id="icon-${query.id}">‚ñº</span>' : ''}
                        </div>
                    </div>
                    ${hasData ? `
                        <div class="query-content" id="content-${query.id}">
                            ${isAITrajectory ? renderAITrajectory(data) : renderStandardData(data)}
                        </div>
                    ` : ''}
                </div>
            `;
        }

        function renderAITrajectory(data) {
            if (!data.data || !data.data.timeline) {
                return `<div class="data-preview">${JSON.stringify(data, null, 2)}</div>`;
            }

            const { analysis, timeline, summary } = data.data;

            return `
                <div class="ai-analysis-text">
                    <h3 style="margin-bottom: 15px; color: #667eea;">üìä Comprehensive AI Impact Analysis</h3>
                    <p>${analysis}</p>
                </div>

                <div style="margin-top: 25px;">
                    <h3 style="margin-bottom: 15px; color: #333;">üìÖ AI Takeover Timeline</h3>
                    <div class="ai-trajectory-timeline">
                        ${timeline.map(item => `
                            <div class="timeline-item">
                                <div class="timeline-year">${item.year}</div>
                                <div>
                                    <div class="timeline-data">
                                        <div>
                                            <strong>${item.horizon_label}</strong>
                                            <div class="takeover-pct">${item.takeover_pct}% AI Takeover</div>
                                        </div>
                                        <div class="confidence confidence-${item.confidence_level}">
                                            ${item.confidence_level} confidence
                                        </div>
                                    </div>
                                    <ul class="key-factors">
                                        ${item.key_factors.map(f => `<li>${f}</li>`).join('')}
                                    </ul>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>

                <div style="margin-top: 25px; background: white; padding: 20px; border-radius: 8px;">
                    <h3 style="margin-bottom: 15px; color: #333;">üìã Summary</h3>
                    <p><strong>Current Impact:</strong> ${summary.current_impact}</p>
                    <p style="margin-top: 10px;"><strong>Human Advantage:</strong> ${summary.human_advantage}</p>
                    <p style="margin-top: 10px;"><strong>Adaptation Priority:</strong> 
                        <span class="confidence confidence-${summary.adaptation_priority === 'critical' ? 'low' : summary.adaptation_priority === 'high' ? 'medium' : 'high'}">
                            ${summary.adaptation_priority}
                        </span>
                    </p>
                </div>

                <details style="margin-top: 15px;">
                    <summary style="cursor: pointer; padding: 10px; background: white; border-radius: 8px;">
                        üîç View Raw JSON
                    </summary>
                    <div class="data-preview" style="margin-top: 10px;">
                        ${JSON.stringify(data, null, 2)}
                    </div>
                </details>
            `;
        }

        function renderStandardData(data) {
            return `<div class="data-preview">${JSON.stringify(data, null, 2)}</div>`;
        }

        function toggleQuery(queryId) {
            const content = document.getElementById(`content-${queryId}`);
            const icon = document.getElementById(`icon-${queryId}`);
            
            if (!content) return;

            content.classList.toggle('expanded');
            if (icon) {
                icon.classList.toggle('expanded');
            }
        }

        // Search functionality
        document.getElementById('searchBox').addEventListener('input', (e) => {
            const searchTerm = e.target.value.toLowerCase();
            const filtered = allJobs.filter(job => {
                const title = (job.canonicaltitle || job.canonicalTitle || '').toLowerCase();
                const soc = (job.soccode || job.socCode || '').toLowerCase();
                return title.includes(searchTerm) || soc.includes(searchTerm);
            });
            displayJobs(filtered);
        });

        // Initialize
        loadJobs();
    </script>
</body>
</html>
